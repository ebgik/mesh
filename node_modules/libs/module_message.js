var db = require('libs/module_db');
var moment = require('moment');
moment.locale('ru');

exports.addMessage = function(id_sender,id_sel,message,callback) {
	var now = new Date();
	var data = moment(now).format('YYYY-MM-DD HH:mm:SS');
//console.log(data);
	var query = db.query('INSERT INTO message SET id_sender = ?, id_sel = ?, message = ?, date_time = ?',
		[id_sender, id_sel, message, data], 
		function(err, result) {
		  if (err)
		  	callback(err);
		  else
		  {
		  	//callback({ result:'success', date : moment(now).format('LLL')});
		  	var query2 = db.query('SELECT * FROM dialogues WHERE (id_sender = ? AND id_sel = ?) OR (id_sender = ? AND id_sel = ?)',
		  		[id_sender,id_sel,id_sel,id_sender],function(errDia,resultDia){
		  			if (errDia) callback(errDia)
		  			else
		  			{
		  				if (resultDia.length>0)
		  					var query3 = db.query('UPDATE dialogues SET id_last_mess = ? WHERE (id_sender = ? AND id_sel = ?) OR (id_sender = ? AND id_sel = ?)',
		  						[result.insertId,id_sender,id_sel,id_sel,id_sender],function(errDialog,resultDialog){
		  							if (errDialog) callback(errDialog)
		  							else callback({ result:'success', date : moment(now).format('LLL')});
		  						})	
		  				else
		  					var query3 = db.query('INSERT INTO dialogues SET id_sender = ?, id_sel = ?, id_last_mess = ?',
		  						[id_sender,id_sel,result.insertId],function(errDialog,resultDialog){
		  							if (errDialog) callback(errDialog)
		  							else callback({ result:'success', date : moment(now).format('LLL')});
		  						})
		  			}
		  				
		  		})
		  	
		  } 
		  	
		});
}


exports.reading = function(id_sender,id_sel,callback) {
	var query = db.query('UPDATE message SET status = ? WHERE id_sender = ? AND id_sel = ?',
		[1,id_sel,id_sender], 
		function(err, result) {
			//console.log(err)
		  if (err)
		  	callback(err);
		  else 
		  	callback('success');
		});
}

exports.getMessages = function(user,sel,callback){
	//console.log(user+' - '+sel);
	var query = db.query('SELECT M.*, U.name, U.image FROM message AS M, users AS U WHERE ((M.id_sender = ? AND M.id_sel = ?) OR (M.id_sender = ? AND M.id_sel = ?)) AND M.id_sender = U.id ORDER BY M.id',
		[user,sel,sel,user],
		function(err,result){
			//console.log(result)
			if (result[0])
			{
				result.forEach(function(item, i, arr){
				 result[i].date_time = moment(result[i].date_time).format('LLL');
				})
				callback(err,result);
			}
			else callback(err,'none');
		});
	
}


exports.getDialogues = function(id_user,callback){
	var query = db.query('SELECT D.*, U.id, U.name, U.image FROM dialogues AS D, users AS U WHERE (D.id_sender = ? AND D.id_sel = U.id) OR (D.id_sel = ? AND D.id_sender = U.id)',
		[id_user,id_user],
		function(err,result){
			if (result.length>0)
			{
				result.forEach(function(item,i,arr){
					var query2 = db.query('SELECT date_time,message,status FROM message WHERE id = ?',[item.id_last_mess],
						function(errMess,resultMess){
							if (resultMess.length<0) callback(errMess,'nonemess')
							else
							{
								resultMess[0].date_time = moment(resultMess[0].date_time).format('LLL');
								result[i].message = resultMess[0];
								if ((i+1)==result.length)
									callback(err,result)
							}
						})
				})
				
			}
			else callback(err,'none');
		})
}