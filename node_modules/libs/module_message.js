var db = require('libs/module_db');
var moment = require('moment');
moment.locale('ru');

exports.addMessage = function(id_sender,message,callback) {
	var now = new Date();
	var data = moment(now).format('YYYY-MM-DD HH:mm:SS');
console.log(data);
	var query = db.query('INSERT INTO message SET id_sender = ?, message = ?, date_time = ?',[id_sender, message, data], 
		function(err, result) {
		  if (err)
		  	callback(err);
		  else 
		  	callback({ result:'success', date : moment(now).format('LLL')});
		});
}


exports.getMessages = function(count,callback){
	var counter = db.query('SELECT COUNT(*) FROM message',function(errCount,resCount){
		if (errCount) callback(err,'none');
		else
		{
			if (resCount[0]['COUNT(*)']<20)
				start = 1;
			else
			var start = resCount[0]['COUNT(*)']-count-1;

			var query = db.query('SELECT M.*, U.name, U.image FROM message AS M, users AS U WHERE M.id_sender = U.id LIMIT ?,?',
			[start,count],function(err,result){
				if (result)
				{
					result.forEach(function(item, i, arr){
				  		result[i].date_time = moment(result[i].date_time).format('LLL');
				  	})
					callback(err,result);
				}
				else
					callback(err,'none');
			});
		}
		
	})
	
}