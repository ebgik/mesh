var db = require('libs/module_db');
var moment = require('moment');
moment.locale('ru');

exports.addMessage = function(id_sender,id_sel,message,callback) {
	var now = new Date();
	var data = moment(now).format('YYYY-MM-DD HH:mm:SS');
//console.log(data);
	var query = db.query('INSERT INTO message SET id_sender = ?, id_sel = ?, message = ?, date_time = ?',
		[id_sender, id_sel, message, data], 
		function(err, result) {
		  if (err)
		  	callback(err);
		  else 
		  	callback({ result:'success', date : moment(now).format('LLL')});
		});
}


exports.reading = function(id_sender,id_sel,callback) {
	var query = db.query('UPDATE message SET status = ? WHERE id_sender = ? AND id_sel = ?',
		[1,id_sel,id_sender], 
		function(err, result) {
			console.log(err)
		  if (err)
		  	callback(err);
		  else 
		  	callback('success');
		});
}

exports.getMessages = function(user,sel,callback){
	//console.log(user+' - '+sel);
	var query = db.query('SELECT M.*, U.name, U.image FROM message AS M, users AS U WHERE ((M.id_sender = ? AND M.id_sel = ?) OR (M.id_sender = ? AND M.id_sel = ?)) AND M.id_sender = U.id ORDER BY M.id',
		[user,sel,sel,user],
		function(err,result){
			//console.log(result)
			if (result[0])
			{
				result.forEach(function(item, i, arr){
				 result[i].date_time = moment(result[i].date_time).format('LLL');
				})
				callback(err,result);
			}
			else callback(err,'none');
		});
	
}